define(["require","exports","module"],function(e,t){(function(e){function o(e,t,n){var r,i=[],s=n.get("_"+e)[t.classNo];i.push("<b>GROUP: </b>"+t.classNo),i.push("<b>TYPE: </b>"+t.type),i.push("<b>WEEK: </b>"+t.weekType);for(r=0;r<s.length;r++)r===0?i.push("<b>TIME: </b>"+s[r].weekDay+" "+s[r].startTime+"-"+s[r].endTime):i.push("<b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b>"+s[r].weekDay+" "+s[r].startTime+"-"+s[r].endTime);return i.push("<b>ROOM: </b>"+t.room),i.join("<br>")}function u(e,t,n){e==="location"?t.text(n.room):e==="group"?t.text("["+n.classNo+"]"):e==="week"&&t.text(n.weekType)}var t="planner_",n="slot",r=e("#tt-grid"),i=e("#basket-scroll"),s=function(t,n){this.$elem=e(t),this.init(n)};s.prototype={constructor:s,init:function(e){this.$info=this.$elem.find(".opt-info"),this.code=e.code,this.type=e.type,this.slot=e.slot,this.data=e.module,this.id=this.$elem.attr("id"),this.sid=this.id.substr(0,this.id.lastIndexOf("-")),this.updateElem(),this.attachPopover(),this.attachEvents(e.droppable),this.attachDragDrop(e.droppable)},get:function(e){return this.data.get(e)},updateElem:function(){var t=this;this.$elem.data("span")<3&&(this.code.length>7||this.type==="labs")&&(this.$elem.addClass("small"),e.subscribe("app:fullsize",function(e,n){n?t.$elem.removeClass("small"):t.$elem.addClass("small")})),planner.slotType!=="location"&&u(planner.slotType,t.$info,t.slot)},attachPopover:function(){function n(e){e?t.$elem.popover({html:!0,trigger:"hover",placement:t.$elem.data("offset")+t.$elem.data("span")>24?"left":"right",title:t.get("code")+" "+t.get("title"),content:o(t.type,t.slot,t.data)}):t.$elem.popover("destroy")}var t=this;n(planner.slotPopover),e.subscribe("app:slotPopover",function(){n(planner.slotPopover)})},attachEvents:function(t){var n=this;if(t)return;this.$elem.on("mouseenter",function(){n.$elem.hasClass("on-dragging")||(r.find(".slot[id^="+n.code+"-]").addClass("hover"),i.find(".module[id="+n.code+"]").addClass("hover"))}),this.$elem.on("mouseleave",function(){r.find(".slot[id^="+n.code+"-]").removeClass("hover"),i.find(".module[id="+n.code+"]").removeClass("hover")}),this.$elem.on("click",function(){var t=e("#metro-pivot").data("controller"),r=t.headers.children(".current").text();r==="Modules"?(e.publish("module:detail",n.data),t.goToItemByName("Detail")):e("#detail").data("module")===n.code?t.goToItemByName("Modules"):(e.publish("module:detail",n.data),t.goToItemByName("Detail"))}),e.subscribe("app:slotType",function(){u(planner.slotType,n.$info,n.slot)})},attachDragDrop:function(t){var n=this;this.dragOpts={helper:"clone",opacity:.3,cursorAt:{top:20,left:20},revert:"invalid",revertDuration:200,zIndex:1e3,start:e.proxy(n.dragStart,n),stop:e.proxy(n.dragStop,n)},this.dropOpts={activeClass:"highlight",hoverClass:"hover",tolerance:"pointer",over:e.proxy(n.dropOver,n),out:e.proxy(n.dropOut,n),drop:e.proxy(n.dropEvent,n)},t?this.$elem.droppable(this.dropOpts):this.data.count(this.type)>1?this.$elem.draggable(this.dragOpts):this.$elem.addClass("nomove")},dragStart:function(){r.find(".slot[id^="+this.sid+"-]").addClass("on-dragging"),e.publish("grid:module:droppable",[this.slot,this.type,this.data])},dragStop:function(){r.find(".slot[id^="+this.sid+"-]").removeClass("on-dragging"),r.find(".ui-droppable").remove(),e.publish("grid:rows:clearEmpty")},dropEvent:function(t,n){this.$elem.trigger("mouseleave"),n.helper.remove(),r.find(".slot[id^="+this.code+"-"+this.type+"-]").remove(),e.publish("grid:module:allocate",[this.slot,this.type,this.data]),setTimeout(function(){e.publish("grid:rows:clearEmpty")},10)},dropOver:function(){r.find(".slot[id^="+this.sid+"-]").addClass("hover"),this.$elem.popover("show")},dropOut:function(){r.find(".slot[id^="+this.sid+"-]").removeClass("hover"),this.$elem.popover("hide")}},e.fn.slot=function(r){return this.each(function(){e.data(this,t+n)||e.data(this,t+n,new s(this,r))})}})(jQuery)});